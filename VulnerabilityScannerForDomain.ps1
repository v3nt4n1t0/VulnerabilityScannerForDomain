$Output=@()
#$c guarda información de las máquinas del dominio que estén habilitadas. Además especificamos que obtenga la propiedad IPV4Addres que contiene la propieda con la IP versión 4
$c = Get-ADComputer -Properties IPv4Address -Filter {Enabled -eq $true}

Try{
    $cred = Get-Credential -ErrorAction continue #$cred guarda la información de Autenticación que se solicita desde el cmdlet Get-Credential en una variable segura

    $i=0
    echo ""
    if($cred){
        foreach ($Cname in $c.name ) {
            if(test-connection -ComputerName $Cname -Count 1 -Quiet){ #Comprueba si las máquinas están levantadas / responden a ping
                try{
    
                    $machine = Invoke-Command -ComputerName $Cname -Credential $cred -ScriptBlock{
                        ## busqueda NVIDIA Geforce Experience  ##
                        #Búsqueda en el Registro de versiones de aplicaciones 64-bit
                        ls HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall | ForEach-Object -Process {       
                            if($_.GetValue("DisplayName") -like "NVIDIA GeForce Experience*"){
                            $nvidiaExperienceVersion = $_.GetValue("DisplayVersion")
                            $SbStrversion = $nvidiaExperienceVersion.Substring(0,4)
                            }
                        }
                        #Búsqueda en el Registro de versiones de aplicaciones 32bit
                        ls HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall | ForEach-Object -Process {
                            if($_.GetValue("DisplayName") -like "NVIDIA GeForce Experience*"){
                            $nvidiaExperienceVersion = $_.GetValue("DisplayVersion")
                            $SbStrversion = $nvidiaExperienceVersion.Substring(0,4)
                            }
                        }
                        ## busqueda WinRAR  ##
                        ls HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall | ForEach-Object -Process {      
            
                             if($_.GetValue("DisplayName") -like "winrar*"){
                             $winrar = $_.GetValue("DisplayName")
                             $winrarSplit = $winrar.Split(" ")
                             $versionWinRAR = $winrarSplit[1]
                             }
                        }
                        ls HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall | ForEach-Object -Process {
                            if($_.GetValue("DisplayName") -like "winrar*"){
                             $winrar = $_.GetValue("DisplayName")
                             $winrarSplit = $winrar.Split(" ")
                             $versionWinRAR = $winrarSplit[1]
                             }
                        }
                        ## busqueda Mozilla  ##
                        ls HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall | ForEach-Object -Process {      
                            if($_.GetValue("DisplayName") -like "Mozilla Firefox*"){
                                $banderaVersion=$false
                        
                                if($_.GetValue("DisplayName") -like "Mozilla Firefox*ESR*"){
                                    $banderaVersion=$true
                                }
                        
                                $mozilla = $_.GetValue("DisplayName")
                                $mozillaSplit = $mozilla.Split(" ")
                                $versionmozilla = $mozillaSplit[2]
                                $versionmozilla = $versionmozilla.Replace(".","")
                            }
                        }
                        ls HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall -ErrorAction SilentlyContinue | ForEach-Object -Process {
                            if($_.GetValue("DisplayName") -like "Mozilla Firefox*"){
                                $banderaVersion=$false
                        
                                if($_.GetValue("DisplayName") -like "Mozilla Firefox*ESR*"){
                                    $banderaVersion=$true
                                }
                        
                                $mozilla = $_.GetValue("DisplayName")
                                $mozillaSplit = $mozilla.Split(" ")
                                $versionmozilla = $mozillaSplit[2]
                                $versionmozilla = $versionmozilla.Replace(".","")
                            }
                        }


                        #comprueba si tiene instalada la aplicacion Geforce Experience
                        if(!$nvidiaExperienceVersion ){
                            $VulnerableExperience = $false
                            $Description = "NVIDIA GeForce Experience no está instalado. " 
                        }#si la version es menor que la registrada, es vulnerable
                        elseif($SbStrversion -lt 3.19){ #3.19
                            $VulnerableExperience = $true
                            $Description = "GeForce Experience es vulnerable! Actualice a la versión 3.18.0.94 o superior. "
                        }#si no, no es vulnerable
                        else{
                            $VulnerableExperience = $false
                            $Description = "NVIDIA GeForce Experience no es vulnerable. "
                        }
                        #comprobación WinRAR
                        if(!$winrar){
                        $VulnerableWinRAR = $false
                        $Description += "No contiene WinRAR. "
                        }
                        elseif($versionWinRAR -lt 5.70){
                        $VulnerableWinRAR = $true
                        $Description += "Actualizar WinRAR a versión 5.70 o superior"
                        } 
                        else{$VulnerableWinRAR = $false}
                        #comprobación Mozilla
                        if(!$mozilla){
                        $VulnerableMozilla = $false
                        $Description += "No contiene Mozilla Firefox. "}
                        elseif(($banderaVersion=$false) -And ($versionmozilla -lt 7201)){
                        $VulnerableMozilla = $true
                        $Description += "Actualizar Mozilla"
                        }
                        elseif(($banderaVersion=$true) -And ($versionmozilla -lt 6841)){
                        $VulnerableMozilla = $true
                        $Description += "Actualizar Mozilla"
                        }
                        else{$VulnerableMozilla = $false}            
                                    
                        #Obtenemos versión de PowerShell que se está ejecutando en la máquina actual para llenar el Objecto por el método de la v2 o por el método de la v3 y posteriores
                        # Esto evitará problemas futuros al pasar la información obtenida al array de objetos $Output
                        $psversion = Get-Host
                        
                        if($psversion.Version.Major -lt 3){ #Si version de powershell menor que 3 #Para version 2 de PowerShell
                            New-Object -TypeName PSObject -Property @{
                                IP = (Get-WmiObject -class win32_NetworkAdapterConfiguration -Filter 'ipenabled = "true"').ipaddress[0]
                                ComputerName = [Environment]::GetEnvironmentVariable("ComputerName")
                                VulnerableDrivers = $false
                                VulnerableGeForceExperience = $VulnerableExperience
                                VulnerableWinRAR = $VulnerableWinRAR
                                VulnerableMozilla = $VulnerableMozilla
                                TypeGPU = Get-WmiObject -class win32_VideoController -Property AdapterCompatibility #Guardamos propiedades relacionadas con la GPU
                                NameGPU = Get-WmiObject -class win32_VideoController -Property Caption #Guardamos propiedades relacionadas con la GPU
                                GPUVersion = Get-WmiObject  -class win32_VideoController -Property DriverVersion #Guardamos propiedades relacionadas con la GPU
                                PING = "OK"
                                Description = $Description
                            }
                        }
                        else{#para versión 3 o posterior de PowerShell
    
                            [pscustomobject]@{
                                IP = (Get-WmiObject -class win32_NetworkAdapterConfiguration -Filter 'ipenabled = "true"').ipaddress[0]
                                ComputerName = [Environment]::GetEnvironmentVariable("ComputerName")
                                VulnerableDrivers = $false
                                VulnerableGeForceExperience = $VulnerableExperience
                                VulnerableWinRAR = $VulnerableWinRAR
                                VulnerableMozilla = $VulnerableMozilla
                                TypeGPU = Get-WmiObject -class win32_VideoController -Property AdapterCompatibility
                                NameGPU = Get-WmiObject -class win32_VideoController -Property Caption
                                GPUVersion = Get-WmiObject  -class win32_VideoController -Property DriverVersion
                                PING = "OK"
                                Description = $Description
                            }
                        }
    
                    }#scriptblock
                
    
                    #Comprobación de tipo de tarjeta gráfica (Geforce, Quadro, tesla) y versiones de drivers instalados para GPU NVIDIA
                    if($machine.TypeGPU.AdapterCompatibility -like '*NVIDIA*') 
                    {
                        $version = $machine.GPUVersion.DriverVersion.Substring($machine.GPUVersion.DriverVersion.Length - 6, 6)
    
                        if($machine.NameGPU.Caption -like '*Geforce*') {
                            if($version -lt 4.3160){
                                $machine.VulnerableDrivers = $true
                                $machine.Description += "Actualiza drivers de NVIDIA a version 419.17 o superior. "
                            }
                        }
                        elseif(($machine.NameGPU.Caption -like '*Quadro*') -or ($machine.NameGPU.Caption -like '*NVS*')){
                            if($version -lt 4.3170){
                                $machine.VulnerableDrivers = $true
                                $machine.Description += "Actualiza drivers de NVIDIA a version 419.17 o superior. "
                            }
                        }
                        elseif($machine.NameGPU.Caption -like '*Tesla*'){
                            if($version -lt 4.2525){
                                $machine.VulnerableDrivers = $true
                                $machine.Description += "Actualiza drivers de NVIDIA a version 412.29 o superior. "
                            }
                        }
    
                    }
                    else{$machine.Description += "$Cname No dispone de GPU NVIDIA o no tiene instalado los drivers de NVIDIA. "}
       
    
                }catch{ $machine.Description += "$Cname está activa pero la comprobación no puede ser realizada. Verifique que las credenciales de Administrador son correctas, que la máquina remota tiene activado WinRM, o que las reglas de firewall no están bloqueando la conexión. "}
            }
            else{
                #rellena el objeto machine con los datos 'false' de la maquina correspondiente si la conexion falla
                $machine.IP = $c.IPV4Address[$i]
                $machine.ComputerName = $Cname
                $machine.VulnerableDrivers = $false
                $machine.VulnerableGeForceExperience = $false 
                $machine.VulnerableWinRAR = $false
                $machine.VulnerableMozilla = $false
                $machine.PING = "FAILED"
                $machine.Description = "$Cname no responde a ping o la máquina está apagada. Comprueba que las reglas de firewall no bloquean la conexión. "
                }
            #añade los datos de las maquinas correspondientes a un array de objetos
            $Output += $machine | select IP,ComputerName,VulnerableDrivers,VulnerableGeforceExperience,VulnerableWinRAR,VulnerableMozilla,PING,Description
            
            $i++
        }#foreach
    
        #muestra la salida
        $Output 
    
        Write-Host -ForegroundColor Yellow "`n`nRecuerde cerrar la tabla gráfica para continuar con la ejecución del script`n`n"
        
        #$respuestaOut = Read-Host "¿Quieres visualizar los resultados en una tabla con filtros?(S/N)"
        $Output | Out-GridView -Wait -Title "List of machines with NVIDIA vulnerable software"     
        
        
        do{
        
            $respuestaCSV = Read-Host "`n`n¿Quieres exportar los resultados en un archivo CSV?(S/N)"
        
        }while(($respuestaCSV -notlike 's') -And ($respuestaCSV -notlike 'n')) #Repetir pregunta mientras la respuesta no sea 's' o 'n'
        
        #------------------------------------#
        # Exportar resultados en archivo CSV #
        #------------------------------------#
        if($respuestaCSV -like 's'){
            
            $Output |  Export-Csv -Path .\AppVulnerablesDominio.csv -NoTypeInformation
        
            Write-Host -ForegroundColor Green "`n`nSe han exportados los resultados en formato csv correctamente en el archivo AppVulnerablesDominio.csv`n`n"
        
        }
        
    }
#else{ Write-Host -ForegroundColor Red -BackgroundColor Yellow "Administrator credentials are required to run the script`n"}
}catch {
    
    Write-Host -ForegroundColor Red -BackgroundColor Yellow "`nLas credenciales de Administrador son necesarias para ejecutar el script`n"
    return
}

